<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Medical Assistant AI</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
</head>
<body>
  <div class="app-container">
    <!-- Sidebar -->
    <aside class="sidebar" id="sidebar">
      <div class="sidebar-header">
        <div class="logo">
          <i class="fas fa-user-md"></i>
          <span>MedAssist AI</span>
        </div>
        <button class="sidebar-toggle" id="sidebarToggle">
          <i class="fas fa-bars"></i>
        </button>
      </div>
      
      <div class="sidebar-content">
        <button class="new-chat-btn" onclick="startNewChat()">
          <i class="fas fa-plus"></i>
          <span>New Chat</span>
        </button>
        
        <div class="search-container">
          <i class="fas fa-search"></i>
          <input type="text" placeholder="Search conversations..." id="searchInput">
        </div>
        
        <div class="conversations-list" id="conversationsList">
          <div class="conversation-item active" onclick="selectConversation(this)">
            <i class="fas fa-comments"></i>
            <span>Current Chat</span>
            <i class="fas fa-ellipsis-h options"></i>
          </div>
        </div>
      </div>
      
      <div class="sidebar-footer">
        <div class="user-profile">
          <i class="fas fa-user-circle"></i>
          <span>Medical Chat</span>
        </div>
      </div>
    </aside>

    <!-- Main Chat Area -->
    <main class="main-content">
      <header class="chat-header">
        <div class="header-left">
          <button class="mobile-toggle" id="mobileToggle">
            <i class="fas fa-bars"></i>
          </button>
          <div class="assistant-info">
            <div class="assistant-avatar">
              <i class="fas fa-stethoscope"></i>
            </div>
            <div class="assistant-details">
              <h2>Medical Assistant</h2>
              <span class="status">Online â€¢ Ready to help</span>
            </div>
          </div>
        </div>
        <div class="header-right">
          <button class="header-btn" title="Clear Chat">
            <i class="fas fa-trash"></i>
          </button>
          <button class="header-btn" title="Settings">
            <i class="fas fa-cog"></i>
          </button>
        </div>
      </header>

      <div class="chat-container" id="chatContainer">
        <div class="welcome-message">
          <div class="welcome-icon">
            <i class="fas fa-heartbeat"></i>
          </div>
          <h3>Hello! I'm your Medical Assistant</h3>
          <p>I can help answer your health-related questions and provide general medical information. Please remember that I'm not a substitute for professional medical advice.</p>
          
          <div class="suggestion-cards">
            <div class="suggestion-card" onclick="sendSuggestion('What are the symptoms of common cold?')">
              <i class="fas fa-thermometer-half"></i>
              <span>Cold Symptoms</span>
            </div>
            <div class="suggestion-card" onclick="sendSuggestion('How to maintain a healthy diet?')">
              <i class="fas fa-apple-alt"></i>
              <span>Healthy Diet</span>
            </div>
            <div class="suggestion-card" onclick="sendSuggestion('When should I see a doctor?')">
              <i class="fas fa-user-md"></i>
              <span>See a Doctor</span>
            </div>
            <div class="suggestion-card" onclick="sendSuggestion('How to manage stress?')">
              <i class="fas fa-leaf"></i>
              <span>Stress Management</span>
            </div>
          </div>
        </div>
      </div>

      <div class="input-area">
        <div class="input-container">
          <div class="input-wrapper">
            <textarea
              id="messageInput"
              class="message-input"
              placeholder="Ask me about your health concerns..."
              onkeydown="handleKeyDown(event)"
              oninput="adjustTextareaHeight(this)"
              rows="1"></textarea>
            <button id="sendBtn" class="send-btn" onclick="sendMessage()" title="Send message">
              <i class="fas fa-paper-plane"></i>
            </button>
          </div>
        </div>
      </div>
    </main>
  </div>

  <script>
    const chatContainer = document.getElementById('chatContainer');
    const inputEl = document.getElementById('messageInput');
    const sendBtn = document.getElementById('sendBtn');
    const sidebar = document.getElementById('sidebar');
    const sidebarToggle = document.getElementById('sidebarToggle');
    const mobileToggle = document.getElementById('mobileToggle');
    
    let isFirstMessage = true;

    // Sidebar toggle functionality
    sidebarToggle.addEventListener('click', () => {
      sidebar.classList.toggle('collapsed');
    });

    mobileToggle.addEventListener('click', () => {
      sidebar.classList.toggle('mobile-open');
    });

    // Auto-resize textarea
    function adjustTextareaHeight(el) {
      el.style.height = 'auto';
      el.style.height = Math.min(el.scrollHeight, 120) + 'px';
    }

    // Handle Enter key
    function handleKeyDown(e) {
      if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        sendMessage();
      }
    }

    // Timestamp
    function timeStamp() {
      const d = new Date();
      return d.getHours().toString().padStart(2,'0') + ':' + d.getMinutes().toString().padStart(2,'0');
    }

    // Escape HTML
    function escapeHtml(str) {
      return str.replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));
    }

    // Clear welcome message on first user message
    function clearWelcome() {
      if (isFirstMessage) {
        const welcome = document.querySelector('.welcome-message');
        if (welcome) welcome.remove();
        isFirstMessage = false;
      }
    }

    // Append user message
    function appendUser(text) {
      clearWelcome();
      const html = `
        <div class="message-group user-group">
          <div class="message user-message">
            <div class="message-content">
              ${escapeHtml(text)}
            </div>
            <div class="message-time">${timeStamp()}</div>
          </div>
          <div class="message-avatar user-avatar">
            <i class="fas fa-user"></i>
          </div>
        </div>`;
      chatContainer.insertAdjacentHTML('beforeend', html);
      scrollToBottom();
    }

    // Typing animation for bot response
    function typeText(element, text, speed = 30) {
      return new Promise((resolve) => {
        let i = 0;
        element.innerHTML = '';
        
        function type() {
          if (i < text.length) {
            if (text.charAt(i) === '<') {
              // Handle HTML tags
              let tagEnd = text.indexOf('>', i);
              element.innerHTML += text.substring(i, tagEnd + 1);
              i = tagEnd + 1;
            } else {
              element.innerHTML += text.charAt(i);
              i++;
            }
            setTimeout(type, speed);
          } else {
            resolve();
          }
        }
        type();
      });
    }

    // Append bot message with typing effect
    async function appendBot(text) {
      clearWelcome();
      const html = `
        <div class="message-group bot-group">
          <div class="message-avatar bot-avatar">
            <i class="fas fa-stethoscope"></i>
          </div>
          <div class="message bot-message">
            <div class="message-content" id="typing-content"></div>
            <div class="message-time">${timeStamp()}</div>
          </div>
        </div>`;
      chatContainer.insertAdjacentHTML('beforeend', html);
      scrollToBottom();
      
      const typingElement = document.getElementById('typing-content');
      const formattedText = escapeHtml(text).replace(/\n/g, '<br>');
      await typeText(typingElement, formattedText);
      typingElement.removeAttribute('id');
    }

    // Loading animation
    function showLoading() {
      clearWelcome();
      const html = `
        <div class="message-group bot-group loading-group">
          <div class="message-avatar bot-avatar">
            <i class="fas fa-stethoscope"></i>
          </div>
          <div class="message bot-message">
            <div class="message-content">
              <div class="typing-indicator">
                <span></span>
                <span></span>
                <span></span>
              </div>
            </div>
          </div>
        </div>`;
      chatContainer.insertAdjacentHTML('beforeend', html);
      scrollToBottom();
    }

    function hideLoading() {
      const loading = document.querySelector('.loading-group');
      if (loading) loading.remove();
    }

    // Scroll to bottom
    function scrollToBottom() {
      chatContainer.scrollTop = chatContainer.scrollHeight;
    }

    // Send message
    async function sendMessage(messageOverride) {
      const text = (messageOverride !== undefined ? messageOverride : inputEl.value).trim();
      if (!text) return;
      
      inputEl.value = '';
      adjustTextareaHeight(inputEl);
      appendUser(text);
      showLoading();
      
      try {
        const response = await fetch('/api/chat', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ message: text })
        });
        
        hideLoading();
        
        if (!response.ok) {
          await appendBot('Sorry, I encountered an error. Please try again.');
          return;
        }
        
        const data = await response.json();
        if (data.answer) {
          await appendBot(data.answer);
        } else {
          await appendBot(data.error || 'No response received.');
        }
      } catch (error) {
        hideLoading();
        await appendBot('Network error. Please check your connection and try again.');
      }
    }

    // Send suggestion
    function sendSuggestion(text) {
      sendMessage(text);
    }

    // New chat
    function startNewChat() {
      chatContainer.innerHTML = `
        <div class="welcome-message">
          <div class="welcome-icon">
            <i class="fas fa-heartbeat"></i>
          </div>
          <h3>Hello! I'm your Medical Assistant</h3>
          <p>I can help answer your health-related questions and provide general medical information. Please remember that I'm not a substitute for professional medical advice.</p>
          
          <div class="suggestion-cards">
            <div class="suggestion-card" onclick="sendSuggestion('What are the symptoms of common cold?')">
              <i class="fas fa-thermometer-half"></i>
              <span>Cold Symptoms</span>
            </div>
            <div class="suggestion-card" onclick="sendSuggestion('How to maintain a healthy diet?')">
              <i class="fas fa-apple-alt"></i>
              <span>Healthy Diet</span>
            </div>
            <div class="suggestion-card" onclick="sendSuggestion('When should I see a doctor?')">
              <i class="fas fa-user-md"></i>
              <span>See a Doctor</span>
            </div>
            <div class="suggestion-card" onclick="sendSuggestion('How to manage stress?')">
              <i class="fas fa-leaf"></i>
              <span>Stress Management</span>
            </div>
          </div>
        </div>`;
      isFirstMessage = true;
    }

    // Select conversation
    function selectConversation(element) {
      document.querySelectorAll('.conversation-item').forEach(item => {
        item.classList.remove('active');
      });
      element.classList.add('active');
    }

    // Focus input on load
    inputEl.focus();
  </script>
</body>
</html>